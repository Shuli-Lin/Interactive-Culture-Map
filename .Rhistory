req(info())
paste("çœä»½ï¼š", info()$Province_CN, " Shengfen:", info()$Province_PY)
})
output$selected_song <- renderText({
req(info())
paste("æ­Œæ›²ï¼š", info()$FolkSong_CN, " Pinyin:", info()$FolkSong_PY)
})
output$selected_song_title_en <- renderText({
req(info())
paste("Song Title (EN):", info()$FolkSong_EN)
})
# æ°‘æ­Œåœ°å›¾
output$folkMap <- renderLeaflet({
leaflet(china_data) %>%
addTiles() %>%
addPolygons(
fillColor = "orange",
color = "white",
weight = 1,
opacity = 1,
fillOpacity = 0.7,
layerId = ~Province_CN,
label = ~paste0(Province_CN, " - ", FolkSong_CN)
)
})
# æ–‡æ˜åœ°å›¾
output$civilizationMap <- renderLeaflet({
leaflet(china_civilization) %>%
addTiles() %>%
addPolygons(
fillColor = "purple",
color = "white",
weight = 1,
opacity = 1,
fillOpacity = 0.6,
layerId = ~Province_CN,
label = ~paste0(Province_CN, ' - ', `æ–‡æ˜ç±»å‹(Civilization Type)`)
)
})
observeEvent(input$civilizationMap_shape_click, {
province <- input$civilizationMap_shape_click$id
info_civ <- china_civilization %>% filter(Province_CN == province)
output$selected_civ_province <- renderText({ paste("çœä»½ï¼š", info_civ$Province_CN) })
output$selected_civ_type <- renderText({ paste("æ–‡æ˜ç±»å‹ï¼š", info_civ$`æ–‡æ˜ç±»å‹(Civilization Type)`) })
output$selected_civ_intro <- renderText({ paste("æ–‡åŒ–ç®€ä»‹ï¼š", info_civ$`ä¸­æ–‡æ–‡åŒ–ç®€ä»‹(CN Overview)`) })
output$selected_civ_pinyin <- renderText({ paste("æ‹¼éŸ³ï¼š", info_civ$æ±‰è¯­æ‹¼éŸ³) })
output$selected_civ_intro_en <- renderText({ paste("Overview (EN):", info_civ$`English Summary`) })
})
}
# -------------------------------
# å¯åŠ¨åº”ç”¨
# -------------------------------
shinyApp(ui, server)
# -------------------------------
# app.R å®Œæ•´ç‰ˆ
# -------------------------------
library(shiny)
library(leaflet)
library(sf)
library(dplyr)
library(readxl)
library(shinydashboard)
# -------------------------------
# è¯»å–æ•°æ®
# -------------------------------
china <- st_read("data/china_provinces.geojson")
# ä¿®æ­£åç§°
corrections <- c(
"Guangzhou Province" = "Guangdong Province",
"Ningxia Ningxia Hui Autonomous Region" = "Ningxia Hui Autonomous Region"
)
china <- china %>%
mutate(shapeName = ifelse(shapeName %in% names(corrections),
corrections[match(shapeName, names(corrections))],
shapeName))
china <- china %>%
mutate(Province_CN = case_when(
shapeName == "Anhui Province" ~ "å®‰å¾½çœ",
shapeName == "Beijing Municipality" ~ "åŒ—äº¬å¸‚",
shapeName == "Chongqing Municipality" ~ "é‡åº†å¸‚",
shapeName == "Fujian Province" ~ "ç¦å»ºçœ",
shapeName == "Gansu Province" ~ "ç”˜è‚ƒçœ",
shapeName == "Guangdong Province" ~ "å¹¿ä¸œçœ",
shapeName == "Guangxi Zhuang Autonomous Region" ~ "å¹¿è¥¿å£®æ—è‡ªæ²»åŒº",
shapeName == "Guizhou Province" ~ "è´µå·çœ",
shapeName == "Hainan Province" ~ "æµ·å—çœ",
shapeName == "Hebei Province" ~ "æ²³åŒ—çœ",
shapeName == "Heilongjiang Province" ~ "é»‘é¾™æ±Ÿçœ",
shapeName == "Henan Province" ~ "æ²³å—çœ",
shapeName == "Hong Kong Special Administrative Region" ~ "é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº",
shapeName == "Hubei Province" ~ "æ¹–åŒ—çœ",
shapeName == "Hunan Province" ~ "æ¹–å—çœ",
shapeName == "Inner Mongolia Autonomous Region" ~ "å†…è’™å¤è‡ªæ²»åŒº",
shapeName == "Jiangsu Province" ~ "æ±Ÿè‹çœ",
shapeName == "Jiangxi Province" ~ "æ±Ÿè¥¿çœ",
shapeName == "Jilin Province" ~ "å‰æ—çœ",
shapeName == "Liaoning Province" ~ "è¾½å®çœ",
shapeName == "Macau Special Administrative Region" ~ "æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº",
shapeName == "Ningxia Hui Autonomous Region" ~ "å®å¤å›æ—è‡ªæ²»åŒº",
shapeName == "Qinghai Province" ~ "é’æµ·çœ",
shapeName == "Shaanxi Province" ~ "é™•è¥¿çœ",
shapeName == "Shandong Province" ~ "å±±ä¸œçœ",
shapeName == "Shanghai Municipality" ~ "ä¸Šæµ·å¸‚",
shapeName == "Shanxi Province" ~ "å±±è¥¿çœ",
shapeName == "Sichuan Province" ~ "å››å·çœ",
shapeName == "Tianjin Municipality" ~ "å¤©æ´¥å¸‚",
shapeName == "Tibet Autonomous Region" ~ "è¥¿è—è‡ªæ²»åŒº",
shapeName == "Xinjiang Uyghur Autonomous Region" ~ "æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº",
shapeName == "Yunnan Province" ~ "äº‘å—çœ",
shapeName == "Zhejiang Province" ~ "æµ™æ±Ÿçœ",
shapeName == "Taiwan Province" ~ "å°æ¹¾çœ",
TRUE ~ shapeName
))
province_info <- read_excel("data/province_info.xlsx")
china_data <- china %>%
left_join(province_info, by = "Province_CN")
civilization_table <- read_excel("data/civilization.xlsx")
china_civilization <- left_join(china, civilization_table, by = "Province_CN")
# -------------------------------
# UI
# -------------------------------
ui <- dashboardPage(
dashboardHeader(title = "ä¸­å›½åœ°æ–¹æ–‡åŒ–åœ°å›¾"),
dashboardSidebar(
sidebarMenu(
menuItem("æ°‘æ­Œåœ°å›¾ ğŸµ", tabName = "folk", icon = icon("music")),
menuItem("æ–‡æ˜åœ°å›¾ ğŸº", tabName = "civilization", icon = icon("globe-asia"))
)
),
dashboardBody(
tags$head(
tags$script(HTML("
// ====== JS éŸ³é¢‘æ§åˆ¶é€»è¾‘ ======
var audioPool = {};
var playlist = [];
var currentIndex = -1;
var currentAudio = null;
Shiny.addCustomMessageHandler('preloadAudio', function(data) {
data.forEach(function(filePath) {
if (!(filePath in audioPool)) {
var audio = new Audio(filePath);
audio.preload = 'auto';
audioPool[filePath] = audio;
playlist.push(filePath);
}
});
});
Shiny.addCustomMessageHandler('playAudio', function(filePath) {
if(filePath in audioPool){
if(currentAudio) currentAudio.pause();
currentAudio = audioPool[filePath];
currentAudio.currentTime = 0;
currentAudio.play();
currentIndex = playlist.indexOf(filePath);
updateProgress();
}
});
function playNext() {
if(currentIndex < playlist.length - 1){
currentIndex++;
Shiny.setInputValue('audio_click_play', playlist[currentIndex]);
}
}
function playPrev() {
if(currentIndex > 0){
currentIndex--;
Shiny.setInputValue('audio_click_play', playlist[currentIndex]);
}
}
function updateProgress() {
if(currentAudio){
var progressBar = document.getElementById('audioProgress');
progressBar.max = currentAudio.duration || 0;
setInterval(function(){
if(currentAudio && progressBar){
progressBar.value = currentAudio.currentTime;
}
}, 500);
}
}
function togglePlayPause() {
if(currentAudio){
if(currentAudio.paused) currentAudio.play();
else currentAudio.pause();
}
}
"))
),
tabItems(
tabItem(tabName = "folk",
fluidRow(
box(width = 8,
leafletOutput("folkMap", height = 600)),
box(width = 4,
title = "ğŸ¶ çœä»½æ°‘æ­Œæ’­æ”¾",
textOutput("selected_province"),
textOutput("selected_song_title_en"),
textOutput("selected_song"),
div(
style = "margin-top:10px;",
actionButton("prev_btn", "â®ï¸ Prev"),
actionButton("play_btn", "â–¶ï¸ Play/Pause"),
actionButton("next_btn", "â­ï¸ Next"),
br(),
tags$input(id="audioProgress", type="range", min=0, value=0, style="width:100%;")
)
)
)
),
tabItem(tabName = "civilization",
fluidRow(
box(width = 8,
leafletOutput("civilizationMap", height = 600)),
box(width = 4,
title = "ğŸº æ–‡æ˜ç±»å‹ä¿¡æ¯",
textOutput("selected_civ_province"),
textOutput("selected_civ_type"),
textOutput("selected_civ_intro"),
textOutput("selected_civ_intro_en"),
textOutput("selected_civ_pinyin"))
)
)
)
)
)
# -------------------------------
# Server
# -------------------------------
server <- function(input, output, session) {
info <- reactiveVal(NULL)
# é¢„åŠ è½½éŸ³é¢‘
observe({
audio_files <- china_data$AudioFile
audio_paths <- paste0("audio/", audio_files)
session$sendCustomMessage("preloadAudio", audio_paths)
})
# ç‚¹å‡»æ°‘æ­Œåœ°å›¾æ’­æ”¾
observeEvent(input$folkMap_shape_click, {
province <- input$folkMap_shape_click$id
info_subset <- china_data %>% filter(Province_CN == province)
info(info_subset)
session$sendCustomMessage(
"playAudio",
paste0("audio/", info_subset$AudioFile)
)
})
# JS æ’­æ”¾æ§åˆ¶æŒ‰é’®
observeEvent(input$play_btn, { session$sendCustomMessage("playAudioToggle", NULL) })
observeEvent(input$prev_btn, { session$sendCustomMessage("playPrev", NULL) })
observeEvent(input$next_btn, { session$sendCustomMessage("playNext", NULL) })
# æ˜¾ç¤ºä¿¡æ¯
output$selected_province <- renderText({
req(info())
paste("çœä»½ï¼š", info()$Province_CN, " Shengfen:", info()$Province_PY)
})
output$selected_song <- renderText({
req(info())
paste("æ­Œæ›²ï¼š", info()$FolkSong_CN, " Pinyin:", info()$FolkSong_PY)
})
output$selected_song_title_en <- renderText({
req(info())
paste("Song Title (EN):", info()$FolkSong_EN)
})
# æ°‘æ­Œåœ°å›¾
output$folkMap <- renderLeaflet({
leaflet(china_data) %>%
addTiles() %>%
addPolygons(
fillColor = "orange",
color = "white",
weight = 1,
opacity = 1,
fillOpacity = 0.7,
layerId = ~Province_CN,
label = ~paste0(Province_CN, " - ", FolkSong_CN)
)
})
# æ–‡æ˜åœ°å›¾
output$civilizationMap <- renderLeaflet({
leaflet(china_civilization) %>%
addTiles() %>%
addPolygons(
fillColor = "purple",
color = "white",
weight = 1,
opacity = 1,
fillOpacity = 0.6,
layerId = ~Province_CN,
label = ~paste0(Province_CN, ' - ', `æ–‡æ˜ç±»å‹(Civilization Type)`)
)
})
observeEvent(input$civilizationMap_shape_click, {
province <- input$civilizationMap_shape_click$id
info_civ <- china_civilization %>% filter(Province_CN == province)
output$selected_civ_province <- renderText({ paste("çœä»½ï¼š", info_civ$Province_CN) })
output$selected_civ_type <- renderText({ paste("æ–‡æ˜ç±»å‹ï¼š", info_civ$`æ–‡æ˜ç±»å‹(Civilization Type)`) })
output$selected_civ_intro <- renderText({ paste("æ–‡åŒ–ç®€ä»‹ï¼š", info_civ$`ä¸­æ–‡æ–‡åŒ–ç®€ä»‹(CN Overview)`) })
output$selected_civ_pinyin <- renderText({ paste("æ‹¼éŸ³ï¼š", info_civ$æ±‰è¯­æ‹¼éŸ³) })
output$selected_civ_intro_en <- renderText({ paste("Overview (EN):", info_civ$`English Summary`) })
})
}
# -------------------------------
# å¯åŠ¨åº”ç”¨
# -------------------------------
shinyApp(ui, server)
runApp('apptest.R')
library(shiny)
library(leaflet)
library(sf)
library(dplyr)
library(readxl)
library(shinydashboard)
# -------------------------------
# æ•°æ®è¯»å–
# -------------------------------
china <- st_read("data/china_provinces.geojson")
corrections <- c(
"Guangzhou Province" = "Guangdong Province",
"Ningxia Ningxia Hui Autonomous Region" = "Ningxia Hui Autonomous Region"
)
china <- china %>%
mutate(shapeName = ifelse(shapeName %in% names(corrections),
corrections[match(shapeName, names(corrections))],
shapeName))
china <- china %>%
mutate(Province_CN = case_when(
shapeName == "Anhui Province" ~ "å®‰å¾½çœ",
shapeName == "Beijing Municipality" ~ "åŒ—äº¬å¸‚",
shapeName == "Chongqing Municipality" ~ "é‡åº†å¸‚",
shapeName == "Fujian Province" ~ "ç¦å»ºçœ",
shapeName == "Gansu Province" ~ "ç”˜è‚ƒçœ",
shapeName == "Guangdong Province" ~ "å¹¿ä¸œçœ",
shapeName == "Guangxi Zhuang Autonomous Region" ~ "å¹¿è¥¿å£®æ—è‡ªæ²»åŒº",
shapeName == "Guizhou Province" ~ "è´µå·çœ",
shapeName == "Hainan Province" ~ "æµ·å—çœ",
shapeName == "Hebei Province" ~ "æ²³åŒ—çœ",
shapeName == "Heilongjiang Province" ~ "é»‘é¾™æ±Ÿçœ",
shapeName == "Henan Province" ~ "æ²³å—çœ",
shapeName == "Hong Kong Special Administrative Region" ~ "é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº",
shapeName == "Hubei Province" ~ "æ¹–åŒ—çœ",
shapeName == "Hunan Province" ~ "æ¹–å—çœ",
shapeName == "Inner Mongolia Autonomous Region" ~ "å†…è’™å¤è‡ªæ²»åŒº",
shapeName == "Jiangsu Province" ~ "æ±Ÿè‹çœ",
shapeName == "Jiangxi Province" ~ "æ±Ÿè¥¿çœ",
shapeName == "Jilin Province" ~ "å‰æ—çœ",
shapeName == "Liaoning Province" ~ "è¾½å®çœ",
shapeName == "Macau Special Administrative Region" ~ "æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº",
shapeName == "Ningxia Hui Autonomous Region" ~ "å®å¤å›æ—è‡ªæ²»åŒº",
shapeName == "Qinghai Province" ~ "é’æµ·çœ",
shapeName == "Shaanxi Province" ~ "é™•è¥¿çœ",
shapeName == "Shandong Province" ~ "å±±ä¸œçœ",
shapeName == "Shanghai Municipality" ~ "ä¸Šæµ·å¸‚",
shapeName == "Shanxi Province" ~ "å±±è¥¿çœ",
shapeName == "Sichuan Province" ~ "å››å·çœ",
shapeName == "Tianjin Municipality" ~ "å¤©æ´¥å¸‚",
shapeName == "Tibet Autonomous Region" ~ "è¥¿è—è‡ªæ²»åŒº",
shapeName == "Xinjiang Uyghur Autonomous Region" ~ "æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº",
shapeName == "Yunnan Province" ~ "äº‘å—çœ",
shapeName == "Zhejiang Province" ~ "æµ™æ±Ÿçœ",
shapeName == "Taiwan Province" ~ "å°æ¹¾çœ",
TRUE ~ shapeName
))
province_info <- read_excel("data/province_info.xlsx")
china_data <- china %>%
left_join(province_info, by = "Province_CN")
civilization_table <- read_excel("data/civilization.xlsx")
china_civilization <- left_join(china, civilization_table, by = "Province_CN")
# -------------------------------
# UI
# -------------------------------
ui <- dashboardPage(
dashboardHeader(title = "ä¸­å›½åœ°æ–¹æ–‡åŒ–åœ°å›¾"),
dashboardSidebar(
sidebarMenu(
menuItem("æ°‘æ­Œåœ°å›¾ ğŸµ", tabName = "folk", icon = icon("music")),
menuItem("æ–‡æ˜åœ°å›¾ ğŸº", tabName = "civilization", icon = icon("globe-asia"))
)
),
dashboardBody(
tags$head(
tags$script(HTML("
var currentAudio = new Audio();
currentAudio.preload = 'auto';
Shiny.addCustomMessageHandler('playAudio', function(filePath) {
if(!filePath) return;
if(!currentAudio.paused) currentAudio.pause();
currentAudio.src = filePath;
currentAudio.currentTime = 0;
currentAudio.play();
var durationEl = document.getElementById('audioDuration');
currentAudio.onloadedmetadata = function() {
durationEl.textContent = formatTime(currentAudio.currentTime) + ' / ' + formatTime(currentAudio.duration);
document.getElementById('audioProgress').max = currentAudio.duration;
};
currentAudio.ontimeupdate = function() {
document.getElementById('audioProgress').value = currentAudio.currentTime;
durationEl.textContent = formatTime(currentAudio.currentTime) + ' / ' + formatTime(currentAudio.duration);
};
});
function togglePlayPause() {
if(currentAudio.paused) currentAudio.play();
else currentAudio.pause();
}
function formatTime(seconds) {
var m = Math.floor(seconds / 60);
var s = Math.floor(seconds % 60);
return m + ':' + (s < 10 ? '0' + s : s);
}
"))
),
tabItems(
tabItem(tabName = "folk",
fluidRow(
box(width = 8,
leafletOutput("folkMap", height = 600)),
box(width = 4,
title = "ğŸ¶ çœä»½æ°‘æ­Œæ’­æ”¾",
textOutput("selected_province"),
textOutput("selected_song_title_en"),
textOutput("selected_song"),
div(
style = "margin-top:10px;",
actionButton("play_btn", "â–¶ï¸ Play/Pause"),
br(),
tags$input(id="audioProgress", type="range", min=0, value=0, style="width:100%;"),
div(id="audioDuration", style="text-align:right; font-size:14px; margin-top:2px;")
)
)
)
),
tabItem(tabName = "civilization",
fluidRow(
box(width = 8,
leafletOutput("civilizationMap", height = 600)),
box(width = 4,
title = "ğŸº æ–‡æ˜ç±»å‹ä¿¡æ¯",
textOutput("selected_civ_province"),
textOutput("selected_civ_type"),
textOutput("selected_civ_intro"),
textOutput("selected_civ_intro_en"),
textOutput("selected_civ_pinyin"))
)
)
)
)
)
# -------------------------------
# Server
# -------------------------------
server <- function(input, output, session) {
info <- reactiveVal(NULL)
observeEvent(input$folkMap_shape_click, {
province <- input$folkMap_shape_click$id
info_subset <- china_data %>% filter(Province_CN == province)
info(info_subset)
session$sendCustomMessage(
"playAudio",
paste0("audio/", info_subset$AudioFile)
)
})
observeEvent(input$play_btn, {
session$sendCustomMessage("togglePlayPause", NULL)
})
output$selected_province <- renderText({
req(info())
paste("çœä»½ï¼š", info()$Province_CN, " Shengfen:", info()$Province_PY)
})
output$selected_song <- renderText({
req(info())
paste("æ­Œæ›²ï¼š", info()$FolkSong_CN, " Pinyin:", info()$FolkSong_PY)
})
output$selected_song_title_en <- renderText({
req(info())
paste("Song Title (EN):", info()$FolkSong_EN)
})
output$folkMap <- renderLeaflet({
leaflet(china_data) %>%
addTiles() %>%
addPolygons(
fillColor = "orange",
color = "white",
weight = 1,
opacity = 1,
fillOpacity = 0.7,
layerId = ~Province_CN,
label = ~paste0(Province_CN, " - ", FolkSong_CN)
)
})
output$civilizationMap <- renderLeaflet({
leaflet(china_civilization) %>%
addTiles() %>%
addPolygons(
fillColor = "purple",
color = "white",
weight = 1,
opacity = 1,
fillOpacity = 0.6,
layerId = ~Province_CN,
label = ~paste0(Province_CN, ' - ', `æ–‡æ˜ç±»å‹(Civilization Type)`)
)
})
observeEvent(input$civilizationMap_shape_click, {
province <- input$civilizationMap_shape_click$id
info_civ <- china_civilization %>% filter(Province_CN == province)
output$selected_civ_province <- renderText({ paste("çœä»½ï¼š", info_civ$Province_CN) })
output$selected_civ_type <- renderText({ paste("æ–‡æ˜ç±»å‹ï¼š", info_civ$`æ–‡æ˜ç±»å‹(Civilization Type)`) })
output$selected_civ_intro <- renderText({ paste("æ–‡åŒ–ç®€ä»‹ï¼š", info_civ$`ä¸­æ–‡æ–‡åŒ–ç®€ä»‹(CN Overview)`) })
output$selected_civ_pinyin <- renderText({ paste("æ‹¼éŸ³ï¼š", info_civ$æ±‰è¯­æ‹¼éŸ³) })
output$selected_civ_intro_en <- renderText({ paste("Overview (EN):", info_civ$`English Summary`) })
})
}
shinyApp(ui, server)
